%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% RAPPORT DE CEI // TNP CONSULTANTS // ETP ADVISOR
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[a4paper, 11pt]{article} % Font size (can be 10pt, 11pt or 12pt) and paper size (remove a4paper for US letter paper)

\renewcommand{\contentsname}{Table des matières}
\renewcommand{\listfigurename}{Table des figures}

\usepackage{hyperref}

\usepackage[babel=true]{csquotes}

\usepackage{standalone}

\usepackage{changepage}

\usepackage{caption}
\usepackage{subcaption}

%\usepackage[a4paper,left=2.5cm,right=2.5cm]{geometry}

\addtolength{\hoffset}{-1cm}
\addtolength{\textwidth}{2cm}
\addtolength{\topmargin}{-1.5cm}
\addtolength{\textheight}{2cm}

\usepackage{indentfirst}
%\usepackage[utf8]{inputenc}
\usepackage{pgfplots}
\usepackage{color}

\usepackage{enumerate}

\usepackage[protrusion=true,expansion=true]{microtype} % Better typography

\renewcommand{\thesection}{\Roman{section}}
\usepackage{titlesec}
%\titlespacing\section{0pt}{20pt plus 4pt minus 2pt}{-5pt plus 2pt minus 2pt}

\usepackage{mathpazo} % Use the Palatino font
\usepackage[T1]{fontenc} % Required for accented characters
\linespread{1.05} % Change line spacing here, Palatino benefits from a slight increase by default

\makeatletter
\renewcommand\@biblabel[1]{\textbf{#1.}} % Change the square brackets for each bibliography item from '[1]' to '1.'
\renewcommand{\@listI}{\itemsep=0pt} % Reduce the space between items in the itemize and enumerate environments and the bibliography

\usepackage{titlesec}
\usepackage[T1]{fontenc}
%\titlespacing{\chapter}{0}{0*}{0*}{}
%\titlespacing{\section}{2ex}{0*}{0*}{}
\usepackage{colortbl}
\usepackage{multirow}

%\newdimen\saveskip % Un registre pour garder la valeur actuelle de \leftskip
\newdimen\chapterskip
\newdimen\sectskip
\newdimen\subsectskip
\newdimen\subsubsectskip

%\saveskip=\leftskip
\chapterskip=10pt     % Espacement pour les chapitres
\sectskip=4ex        % Pour les sections
\subsectskip=10ex    % etc.
\subsubsectskip=18ex

% Reprise de ton code ici, mais en appelant les valeurs définies plus haut

\setcounter{secnumdepth}{3} % On affiche une numérotation sur une profondeur de 3
%\setcounter{tocdepth}{3} % La table des matières va a une profondeur de 3
% Alignement des titres :
%\titlespacing{\chapter} {\chapterskip} {*0} {*0} {}
%\titlespacing{\section} {\sectskip} {*0} {*0} {}
%\titlespacing{\subsection} {\subsectskip} {*0} {*0} {}
%\titlespacing{\subsubsection} {\subsubsectskip} {*0} {*0} {}

% Et ici, on surcharge les commandes \chapter, \section, etc.,
% afin de modifier \leftskip.

\setcounter{tocdepth}{3}

\renewcommand{\thesection}{\Roman{section}}

\titleformat{\paragraph}[hang]{\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
\titlespacing*{\paragraph}{0pt}{3.25ex plus 1ex minus .2ex}{1em}

%----------------------------------------------------------------------------------------
%	FIGURES ET IMAGES
%----------------------------------------------------------------------------------------

\usepackage{graphicx} % Required for including pictures
\usepackage{wrapfig} % Allows in-line images

\usepackage{tikz}
\usetikzlibrary{shapes}
\usepackage{pgf}
\usepackage{pgfplots}
\usetikzlibrary{arrows}
\usepackage{tkz-graph}
\usetikzlibrary{shapes.multipart}

%----------------------------------------------------------------------------------------
%	TITLE
%----------------------------------------------------------------------------------------

\renewcommand{\maketitle}{ % Customize the title - do not edit title and author name here, see the TITLE block below
\begin{flushright} % Right align
{\LARGE\@title} % Increase the font size of the title

\vspace{50pt} % Some vertical space between the title and author name

{\large\@author} % Author name
\\\@date % Date

\vspace{-20pt} % Some vertical space between the author block and abstract
\end{flushright}
}

%-----------

\title{\textbf{Introduction aux Systèmes Multi-Agents}\\ % Title
Projet : SimTransport} % Subtitle

\author{\textsc{Fran\c cois Hernandez - L\'eo Pons} % Author
\\{\textit{CentraleSup\'elec}}} % Institution

\date{\today} % Date

%----------------------------------------------------------------------------------------

\begin{document}

\maketitle % Print the title section

\pagebreak
\tableofcontents

\pagebreak

%----------------------------------------------------------------------------------------
%	ABSTRACT AND KEYWORDS
%----------------------------------------------------------------------------------------

%\renewcommand{\abstractname}{Summary} % Uncomment to change the name of the abstract to something else



\vspace{30pt} % Some vertical space between the abstract and first section

%----------------------------------------------------------------------------------------
%	ESSAY BODY
%----------------------------------------------------------------------------------------

\section*{Introduction}
\addcontentsline{toc}{section}{Introduction}

Un Système Multi-Agents est un système composé d'un ensemble d'agents, situés dans un certain environnement et interagissant selon certaines relations. Un agent est une entité caractérisée par le fait qu'elle est, au moins partiellement, autonome. Le fonctionnement du système est défini par le fonctionnement des agents, le système central ne fait qu'office d'environnement d'évolution et de communication des différents agents. On parle d'intelligence artificielle distribuée.\\

Ce projet a pour objectif de construire une simulation des transports sur le plateau de Saclay. Pour cela, on utilisera la plateforme Jade. La plateforme Jade est une plateforme répartie d'agents s'exécutant de manière asynchrone (chaque agent est une thread). Chaque agent définit ses actions à l'aide de comportements qu'il exécute les uns après les autres. La programmation de ces comportements se fait de manière à les "entrelacer' dans l'exécution de l'agent. Dans ces comportements, les agents peuvent envoyer et recevoir des messages, mais ils peuvent aussi déclencher d'autre comportements ou même créer d'autres agents.\\

Le but du projet est de simuler et d'étudier des politiques d'aménagement des transports à l'aide d'un simulateur multi-agent. Nous adoptons une modélisation simplifiée pour étudier quelques hypothèses et mesurer l'impact des paramètres sur la simulation.\\

Ce rapport fait le tour de notre travail mais ne va pas forcément au coeur des implémentations, celles-ci étant commentées à même le code.


%------------------------------------------------
\pagebreak
\section{Présentation générale}

Nous avons donc construit un prototype de plateforme pour simuler les déplacements des utilisateurs sur le plateau de Saclay. Cette simulation n'est pas une fin en soi, l'idée est de pouvoir simuler et donc tenter prédire le comportement de ces utilisateurs (par exemple leur propension à choisir les transports en commun) en fonction de différents paramètres (par exemple la fréquence des transports en commun, ou la fermeture d'une route). L'application doit donc pouvoir être utilisée pour estimer l'impact de paramètres réels sur le traffic.

\subsection{Fonctionnement général}

Le prototype comprend un simulateur des déplacements d'agents sur le plateau sur une journée. Les agents qui évoluent au cours de cette journée sont déterminés à l'avance, et ont un emploi du temps à suivre et un choix de mode de transport fixé : soit la voiture, soit les transports en commun et la marche. Au cours de la journée, des embouteillages peuvent se créer pour les voyageurs en voiture s'ils sont trop nombreux, ce qui les ralentit considérablement. Les performances des deux modes de transport (temps passé à voyager) sont relevées pendant toute la journée.\\

À partir de ce simulateur sont possibles deux types de déductions :
\begin{itemize}
\item Des estimations de performances du réseau : avec un pool d'utilisateurs donné, simplement mesurer les performances du réseau, et évaluer la criticité du blocage de certaines routes ou de la suppression de certaines lignes de bus.
\item Des estimations du comportement des utilisateurs : la simulation peut être effectuée sur plusieurs jours. Les agents sont les mêmes de jour en jour, mais choisissent chaque matin d'utiliser la voiture ou les transports en commun en fonction des performances des jours précédents. On peut ainsi étudier l'impact d'un changement dans le réseau sur plusieurs jours et donc l'évolution des choix des utilisateurs.
\end{itemize}


\subsection{Structure globale du code}
 
Le programme comporte les packages suivants :
\begin{itemize}
\item \texttt{Environment} : contient les différents éléments de l'environnement dans lequel se déroulera la simulation (horloge et environnement) ;
\item \texttt{Environment.Points} : contient les différents types de points ;
\item \texttt{Environment.Paths} : contient les différents types de chemins ;
\item \texttt{Graphics} : contient les différentes classes associées à la représentation graphique de la simulation ;
\item \texttt{Individuals} : contient les différentes classes et comportements liés aux individus.
\item \texttt{Util} : contient la classe permettant d'importer les points et chemins stockés au format \texttt{csv} ;
\item \texttt{mainPackage} : contient la classe agent \texttt{Starter} et son comportement \texttt{Days} qui permettent de créer l'environnement et les agents pour lancer la simulation.
\end{itemize}

%------------------------------------------------
\pagebreak
\section{Objets et structure du programme}

Avant même de considérer la partie simulation multi-agents, il faut créer la structure du programme permettant de simuler le problème. La structure choisie est détaillée ci-après.

\subsection{Points}

Afin de représenter les différents points utiles à notre simulation, nous créons les classes suivantes, regroupées dans le package \texttt{Environment.Points} :
\begin{itemize}
\item \texttt{Point} : point "classique" ne représentant pas de lieu particulier, comporte des coordonnées (\texttt{x}, \texttt{y}, \texttt{z}), un \texttt{id} entier et un nom \texttt{name} ainsi que les différents getters et setters utiles ;
\item \texttt{EntryPoint} : point "source" à partir duquel les individus entreront dans la simulation, hérite de \texttt{Point} ;
\item \texttt{InterestPoint} : point "d'intérêt" auquel les individus désireront se rendre, hérite de \texttt{Point} ;
\item \texttt{PreEntryPoint} : point se trouvant avant les points d'entrée, afin d'éviter toute situation où un agent d'un certain type serait bloqué à un \texttt{EntryPoint} ne disposant pas de chemin compatible avec son type.
\end{itemize}

\subsection{Chemins}

Nous représentons aussi différents types de chemins. Pour cela, nous avons fait le choix d'un typage fort des chemins. Nous aurons un objet par type de chemin et par sens (de A vers B). Ainsi, par exemple, pour un chemin qui peut être emprunté par des piétons et des vélos, dans les deux sens, il y aura quatre objets. Les classes sont donc définies de la manière suivante dans le package \texttt{Environment.Paths} :
\begin{itemize}
\item \texttt{Path} : classe mère dont hériteront tous les chemins 'typés', comporte un point \texttt{A} source et un point \texttt{B} destination, les getters et setters associés ainsi que différentes méthodes permettant de récupérer la distance (dans l'espace et projetée sur le plan), le dénivelé et la pente ;
\item \texttt{FootPath} : chemin piéton héritant de \texttt{Path} et comportant une méthode \texttt{weight()} retournant le temps de parcours nécessaire (pour une vitesse moyenne de 5km/h, et prenant en compte la difficulté accrue pour un dénivelé positif) ;
\item \texttt{BikePath} : chemin cycliste héritant de \texttt{Path} et comportant une méthode \texttt{weight()} retournant le temps de parcours nécessaire (pour une vitesse moyenne de 15 km/h prenant en compte la difficulté accrue pour un dénivelé positif) ;
\item \texttt{RoadPath} : chemin routier (agglomération) héritant de \texttt{Path} et comportant une méthode \texttt{weight()} retournant le temps de parcours nécessaire (pour une vitesse moyenne de 35 km/h) ;
\item \texttt{HighwayPath} : chemin routier (nationale) héritant de \texttt{Path} et comportant une méthode \texttt{weight()} retournant le temps de parcours nécessaire (pour une vitesse moyenne de 90 km/h) ;
\item \texttt{BusPath} : chemin représentant un autobus (de vitesse moyenne 50 km/h), héritant de \texttt{Path} et comportant une méthode \texttt{weight()} retournant le temps de parcours nécessaire (calculé à partir de la vitesse et du temps perdu aux arrêts) ;
\item \texttt{RerPath} : chemin représentant un RER (de vitesse moyenne 80 km/h), héritant de \texttt{Path} et comportant une méthode \texttt{weight()} retournant le temps de parcours nécessaire (calculé à partir de la vitesse et du temps perdu aux arrêts) ;
\item \texttt{EntryPath} : chemin entre les \texttt{PreEntryPoint} et \texttt{EntryPoint}, de poids nul (un agent débutera, sans délai, au point d'entrée le plus proche correspondant à son type).
\end{itemize}

\subsection{Temps}

Nous avons aussi créé une classe \texttt{Time} afin de représenter le temps et de pouvoir implémenter une horloge pour notre problème. Cette classe comporte trois attributs byte \texttt{hours}, \texttt{minutes} et \texttt{seconds}, ainsi que leurs getters. Elle comporte aussi les méthodes suivantes :
\begin{itemize}
\item \texttt{incMinute(byte m)} : incrémente l'heure de \texttt{m} minutes ;
\item \texttt{incSeconds(byte s)} : incrémente l'heure de \texttt{s} secondes ;
\item \texttt{equals(Time toCompare)} : retourne un booléen vrai si \texttt{this} et \texttt{toCompare} sont égaux ;
\item \texttt{randomBegin()} : retourne une heure aléatoire de départ du point d'entrée, distribuée selon une gaussienne autour de 10h du matin, entre 2h et 20h, et les minutes sont déterminées aléatoirement ;
\item \texttt{randomEnd(Time begin)} : retourne une heure aléatoire de départ du travail, distribuée selon une gaussienne autour de 18h, comprise entre l'heure d'arrivée plus deux heures et minuit, et les minutes sont déterminées aléatoirement.
\end{itemize}

\subsection{Environnement}

Afin de représenter l'environnement global de notre simulation, nous avons créé une classe \texttt{Environment} qui sera instanciée une unique fois et contiendra les différents éléments du problème.

\paragraph{Attributs}

Cette classe contient les différents éléments de la simulation :
\begin{itemize}
\item \texttt{points} : une \texttt{ArrayList} d'objets \texttt{Point} (classe mère et sous-classes) comprenant l'ensemble des points considérés ;
\item \texttt{carPaths} : une \texttt{ArrayList} d'objets \texttt{Path} n'autorisant que les usagers en voiture (\texttt{RoadPath} et \texttt{HighwayPath}) ;
\item \texttt{publicTransportPaths} : une \texttt{ArrayList} d'objets \texttt{Path} n'autorisant que les usagers non motorisés (\texttt{FootPath}, \texttt{BikePath}, \texttt{BusPath} et \texttt{RerPath}).
\end{itemize}

\paragraph{Méthodes}

En plus des getters et setters usuels, cette classe contient également les méthodes permettant d'implémenter un algorithme de Djikstra afin de retourner le plus court chemin d'un point A à un point B sur le graphe des points de l'environnement.
\begin{itemize}
\item \texttt{initializeWeights} : à partir d'une \texttt{ArrayList<Point>} et d'une \texttt{ArrayList<Path>}, retourne la matrice des poids minimal entre les points, c'est à dire la matrice de taille \texttt{n}x\texttt{n} avec \texttt{n} le nombre de points, contenant l'éventuel poids minimal (s'il existe un chemin) entre deux points ;
\item \texttt{initializePaths} : à partir d'une \texttt{ArrayList<Point>}, d'une \texttt{ArrayList<Path>} et d'une matrice de poids (\texttt{double[][]}, retourne la matrice des éventuels chemins de poids minimal entre les points ;
\item \texttt{shortestPathPointList} : implémente, à partir d'une \texttt{ArrayList<Point>}, d'une \texttt{ArrayList<Path>}, d'un point \texttt{source} et d'un point \texttt{target}, l'algorithme de Djikstra et retourne une \texttt{ArrayList<Point>} contenant les points formant le plus court chemin entre deux points ;
\item \texttt{shortestPath} : récupère la liste des chemins formant le plus court chemin, à partir des méthodes \texttt{findShortestPath} et \texttt{initializePaths} ;
\item \texttt{shortestCarPath} : retourne les chemins formant le plus court chemin pour un usager automobiliste ;
\item \texttt{shortestPublicTransportPath} : retourne les chemins formant le plus court chemin pour un usager non motorisé.
\end{itemize}

\subsection{Import}

La classe \texttt{Import} du package \texttt{Util} permet d'importer les points et chemins depuis des fichiers \texttt{csv}, afin de faciliter l'ajout de nouveaux éléments et la création des différents objets dans le programme.\\

Cette classe constitue un objet qui sera instancié en début de simulation, et qui contient en attributs les différentes listes d'objets (points et chemins) qui constitueront l'environnement. Cette classe contient une méthode pour chaque type d'objet, qui parcourt et parse chaque fichier \texttt{csv} (un par type d'objet), appelle le constructeur associé sur chaque instance, et l'ajoute à l'\texttt{ArrayList} attribut correspondant. Les fichiers \texttt{csv} sont stockés dans le dossier \texttt{objects}.\\

Au début de la simulation, il suffit d'instancier un objet de la classe \texttt{Import} à l'aide de son constructeur, qui appelle dans l'ordre défini les différentes méthodes d'importation des objets, et ensuite de récupérer les différentes listes dont on aura l'utilité à l'aide des getters associés.\\

\pagebreak

\section{Agents et comportements}

\subsection{Horloge}

LÉO

\subsection{Individus}

LÉO

\pagebreak 
\section{Interface}

\subsection{Mode Verbose}

EXPLIQUER RAPIDO LES DIFFERENTS NIVEAUX

\subsection{Interface graphique}

Afin d'avoir une représentation graphique claire des différents points, chemins, et des évènements de la simulation, nous avons choisi de définir une interface graphique à l'aide des outils \texttt{Swing}. Cela consiste en deux classes \texttt{Window} et \texttt{Panel}. \texttt{Window} hérite de la classe \texttt{JFrame} et définit les caractéristiques de la fenêtre qui contiendra le \texttt{Panel}. \texttt{Panel} hérite de la classe \texttt{JPanel} et contient les méthodes associées au dessin des représentations. La méthode \texttt{paintComponent} dessine les différents éléments dans un \texttt{bufferGraphics}, attribut d'une image. L'horloge est également affichée.\\

Afin d'avoir une simulation plus réaliste et de pouvoir mieux se représenter le problème, nous avons choisi de nous baser sur une carte réelle (Google Maps) pour définir nos points et chemins.\\

\begin{figure}[!h]
\begin{center}
\includegraphics[width=0.8\textwidth]{plateau.png}
\caption{Représentation graphique de la simulation}
\vspace{-1cm}
\end{center}
\end{figure}

\paragraph{Représentation des éléments}

Les différents éléments sont ajoutés au \texttt{bufferGraphics} dans la méthode \texttt{paintComponent} via les méthodes de dessin classique de \texttt{Swing}. Les points d'entrée sont représentés par des disques (\texttt{fillCirce}) roses, et les points d'intérêt sont représentés par des disques rouges et leur nom est affiché (\texttt{drawString}).\\

Les chemins de type route sont représentés en noir, et avec un trait plus épais pour les chemins de type nationale ou autoroute. Les chemins de type RER sont représentés en bleu légèrement plus épais. Les chemins piétons et cyclistes sont représentés en vert. Les chemins d'autobus sont représentés en bleu transparent légèrement plus large, afin d'apparaître sur les chemins routier. Enfin, pour les chemin de type \texttt{roadPath} et \texttt{highwayPath}, qui peuvent être saturés, nous avons fait le choix de représenter la saturation par une couleur (vert, orange ou rouge selon le niveau), ainsi qu'avec une épaisseur variable (en fonction du rapport entre le nombre d'agents et la capacité effective).\\

De plus, chaque agent (pouvant représenter plusieurs personnes), est représenté par un pictogramme de la forme d'un bonhomme. Ces pictogrammes se déplacent sur la carte (aux différents points de l'environnement) en suivant le déplacement de l'agent associé. Pour cela, la liste des agents \texttt{Persons} est ajoutée au constructeur du \texttt{Panel}, afin de pouvoir accéder aux informations des objets.\\

Un exemple de simulation avec des chemins saturés est présenté figure XXX.

\begin{figure}
\begin{center}
\includegraphics[width=0.8\textwidth]{saturation.png}
\caption{Simulation provoquant la saturation sur certaines routes}
\end{center}
\end{figure}

\subsection{Lancement d'une simulation}

EXPLIQUER LE LANCEMENT DANS STARTER + DAYS

%------------------------------------------------
\pagebreak

\section{Principaux paramètres de la simulation}

%------------------------------------------------
\pagebreak

\section{Simulation de différentes politiques d'aménagement}


%------------------------------------------------

%\pagebreak
%\section*{Conclusion}
%\addcontentsline{toc}{section}{Conclusion}


%----------------------------------------------------------------------------------------

\end{document}